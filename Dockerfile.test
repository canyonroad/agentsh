# Self-contained integration test for agentsh.
# Installs the deb from a GitHub release, sets up the shell shim,
# starts the server internally, and runs end-to-end tests.
#
# Build:
#   docker build -f Dockerfile.test \
#     --build-arg AGENTSH_TAG=v0.9.2 \
#     -t agentsh-test:latest .
#
# Run:
#   docker run --rm agentsh-test:latest

FROM debian:bookworm-slim

ARG AGENTSH_REPO=canyonroad/agentsh
ARG AGENTSH_TAG=v0.9.2
ARG DEB_ARCH=amd64

# Install dependencies: curl for downloading, bash for shim tests, jq for JSON parsing.
RUN set -eux; \
  apt-get update; \
  apt-get install -y --no-install-recommends ca-certificates curl bash jq; \
  rm -rf /var/lib/apt/lists/*

# Download and install the agentsh deb package.
RUN set -eux; \
  version="${AGENTSH_TAG#v}"; \
  deb="agentsh_${version}_linux_${DEB_ARCH}.deb"; \
  url="https://github.com/${AGENTSH_REPO}/releases/download/${AGENTSH_TAG}/${deb}"; \
  echo "Downloading: ${url}"; \
  curl -fsSL -L "${url}" -o /tmp/agentsh.deb; \
  dpkg -i /tmp/agentsh.deb; \
  rm -f /tmp/agentsh.deb; \
  agentsh --version

# Install the shell shim (replaces /bin/sh and /bin/bash).
RUN agentsh shim install-shell \
  --root / \
  --shim /usr/bin/agentsh-shell-shim \
  --bash \
  --i-understand-this-modifies-the-host

# Embed the test script.
COPY <<'SCRIPT' /test.sh
#!/bin/bash.real
set -euo pipefail

passed=0
failed=0
tests_run=0

pass() {
  passed=$((passed + 1))
  tests_run=$((tests_run + 1))
  echo "  PASS: $1"
}

fail() {
  failed=$((failed + 1))
  tests_run=$((tests_run + 1))
  echo "  FAIL: $1 â€” $2" >&2
}

# -------------------------------------------------------------------
# Pre-flight: verify shim installation
# -------------------------------------------------------------------
echo "=== Pre-flight checks ==="

if [ -f /bin/sh.real ]; then
  pass "/bin/sh.real exists"
else
  fail "/bin/sh.real exists" "file not found"
fi

if [ -f /bin/bash.real ]; then
  pass "/bin/bash.real exists"
else
  fail "/bin/bash.real exists" "file not found"
fi

if [ -f /bin/sh ] && [ /bin/sh -ef /usr/bin/agentsh-shell-shim ]; then
  pass "/bin/sh points to the shim"
elif [ -f /bin/sh ]; then
  pass "/bin/sh exists (shim installed)"
else
  fail "/bin/sh is the shim" "/bin/sh not found"
fi

# Verify policies shipped with the deb
if [ -d /etc/agentsh/policies ] && [ -f /etc/agentsh/policies/default.yaml ]; then
  pass "deb shipped policies to /etc/agentsh/policies"
else
  fail "deb shipped policies" "/etc/agentsh/policies/default.yaml not found"
fi

# -------------------------------------------------------------------
# Start the agentsh server
# -------------------------------------------------------------------
echo ""
echo "=== Starting agentsh server ==="

tmp="$(mktemp -d)"
trap 'set +e; [ -n "${SERVER_PID:-}" ] && kill "$SERVER_PID" 2>/dev/null; rm -rf "$tmp"' EXIT

port=18923
base_url="http://127.0.0.1:${port}"
export AGENTSH_SERVER="$base_url"

cat >"$tmp/config.yml" <<YAML
server:
  http:
    addr: "127.0.0.1:${port}"
  grpc:
    enabled: false
  unix_socket:
    enabled: false

auth:
  type: "none"

metrics:
  enabled: false

health:
  path: "/health"
  readiness_path: "/ready"

policies:
  dir: "/etc/agentsh/policies"
  default: "default"

sessions:
  base_dir: "${tmp}/sessions"
  max_sessions: 10

audit:
  enabled: true
  output: "${tmp}/audit.jsonl"
  storage:
    sqlite_path: "${tmp}/events.db"

sandbox:
  fuse:
    enabled: false
  network:
    enabled: false
  unix_sockets:
    enabled: false
  seccomp:
    execve:
      enabled: false
YAML

agentsh server --config "$tmp/config.yml" >"$tmp/server.log" 2>&1 &
SERVER_PID="$!"

# Wait for server to become healthy.
server_ready=0
for _ in $(seq 1 100); do
  if curl -fsS "${base_url}/health" >/dev/null 2>&1; then
    server_ready=1
    break
  fi
  sleep 0.1
done

if [ "$server_ready" = "1" ]; then
  pass "server started and healthy"
else
  fail "server started and healthy" "server did not become ready"
  echo "--- server log ---" >&2
  head -100 "$tmp/server.log" >&2 || true
  echo "--- end server log ---" >&2
  echo ""
  echo "=== Results: ${passed} passed, ${failed} failed, ${tests_run} total ==="
  exit 1
fi

# -------------------------------------------------------------------
# Create a session
# -------------------------------------------------------------------
echo ""
echo "=== Creating session ==="

sid_json="$(agentsh session create --workspace /tmp --json)"
sid="$(echo "$sid_json" | jq -r '.id')"

if [ -n "$sid" ] && [ "$sid" != "null" ]; then
  pass "session created (id=${sid})"
else
  fail "session created" "failed to parse session id: ${sid_json}"
  echo ""
  echo "=== Results: ${passed} passed, ${failed} failed, ${tests_run} total ==="
  exit 1
fi

# -------------------------------------------------------------------
# Test: basic echo through /bin/sh shim
# -------------------------------------------------------------------
echo ""
echo "=== Shim tests ==="

sh_out="$(AGENTSH_SESSION_ID="$sid" /bin/sh -c 'echo hello_sh' 2>&1 | tr -d '\r' | tail -n 1)"
if [ "$sh_out" = "hello_sh" ]; then
  pass "echo through /bin/sh shim"
else
  fail "echo through /bin/sh shim" "got: ${sh_out}"
fi

# -------------------------------------------------------------------
# Test: basic echo through /bin/bash shim
# -------------------------------------------------------------------
bash_out="$(AGENTSH_SESSION_ID="$sid" /bin/bash -c 'echo hello_bash' 2>&1 | tr -d '\r' | tail -n 1)"
if [ "$bash_out" = "hello_bash" ]; then
  pass "echo through /bin/bash shim"
else
  fail "echo through /bin/bash shim" "got: ${bash_out}"
fi

# -------------------------------------------------------------------
# Test: recursion guard (AGENTSH_IN_SESSION)
# -------------------------------------------------------------------
# When AGENTSH_IN_SESSION is set, the shim should delegate directly to the
# real shell without contacting the server. We set AGENTSH_BIN to a
# nonexistent path to prove the shim doesn't try to call it.
rec_out="$(AGENTSH_BIN=/nonexistent/agentsh AGENTSH_IN_SESSION=1 /bin/sh -c 'echo recursion_ok' 2>&1 | tr -d '\r' | tail -n 1)"
if [ "$rec_out" = "recursion_ok" ]; then
  pass "AGENTSH_IN_SESSION recursion guard"
else
  fail "AGENTSH_IN_SESSION recursion guard" "got: ${rec_out}"
fi

# -------------------------------------------------------------------
# Test: multi-word arguments preserved
# -------------------------------------------------------------------
multi_out="$(AGENTSH_SESSION_ID="$sid" /bin/sh -c 'echo "hello world"' 2>&1 | tr -d '\r' | tail -n 1)"
if [ "$multi_out" = "hello world" ]; then
  pass "multi-word arguments preserved"
else
  fail "multi-word arguments preserved" "got: ${multi_out}"
fi

# -------------------------------------------------------------------
# Test: exit code propagation
# -------------------------------------------------------------------
set +e
AGENTSH_SESSION_ID="$sid" /bin/sh -c 'exit 42' >/dev/null 2>&1
exit_rc=$?
set -e
if [ "$exit_rc" = "42" ]; then
  pass "exit code propagation (42)"
else
  fail "exit code propagation (42)" "got rc=${exit_rc}"
fi

# -------------------------------------------------------------------
# Test: exec through agentsh CLI
# -------------------------------------------------------------------
exec_out="$(agentsh exec "$sid" -- sh -c 'echo exec_ok' 2>&1 | tr -d '\r' | tail -n 1)"
if [ "$exec_out" = "exec_ok" ]; then
  pass "agentsh exec command"
else
  fail "agentsh exec command" "got: ${exec_out}"
fi

# -------------------------------------------------------------------
# Summary
# -------------------------------------------------------------------
echo ""
echo "=== Results: ${passed} passed, ${failed} failed, ${tests_run} total ==="

if [ "$failed" -gt 0 ]; then
  echo ""
  echo "--- server log (last 50 lines) ---" >&2
  tail -50 "$tmp/server.log" >&2 || true
  exit 1
fi

exit 0
SCRIPT

# Use bash.real as entrypoint since /bin/bash is now the shim.
ENTRYPOINT ["/bin/bash.real", "/test.sh"]
