# agentsh detect Command Design

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add a CLI command to detect available security capabilities and generate optimized configurations for any environment.

**Architecture:** Two subcommands under `agentsh detect` - one for inspection, one for config generation. Cross-platform support with unified output structure containing platform-specific fields. Actionable tips guide users to enable missing capabilities.

**Tech Stack:** Go, Cobra CLI, existing capabilities detection infrastructure

---

## Command Structure

```
agentsh detect [--output table|json|yaml]
agentsh detect config [--output <filepath>]
```

### `agentsh detect`

Displays detected security capabilities for the current platform.

**Flags:**
- `--output`, `-o`: Output format (default: `table`)
  - `table`: Human-readable table with checkmarks/X marks
  - `json`: Machine-readable JSON
  - `yaml`: YAML format

**Exit codes:**
- `0`: Success
- `1`: Detection failed

### `agentsh detect config`

Generates a configuration snippet optimized for detected capabilities.

**Flags:**
- `--output`, `-o`: File path to write config (default: stdout)

**Behavior:**
- Prints to stdout by default (pipe-friendly: `agentsh detect config > security.yaml`)
- `--output ./security.yaml` writes directly to file
- Contains only security-related sections: `security:`, `landlock:`, `capabilities:`
- Values tuned based on detected capabilities

---

## Unified Detection Output Format

All platforms use the same structure with platform-specific capability fields:

```yaml
platform: linux           # linux | darwin | windows
security_mode: landlock-only
protection_score: 80

capabilities:
  # Linux-specific
  seccomp: false
  seccomp_user_notify: false
  landlock: true
  landlock_abi: 4
  landlock_network: true
  ebpf: false
  fuse: false
  cgroups_v2: true
  pid_namespace: false
  capabilities_drop: true

  # macOS-specific (when platform == darwin)
  esf: false
  network_extension: false
  sandbox_exec: true
  fuse_t: true
  lima_available: false

  # Windows-specific (when platform == windows)
  app_container: true
  minifilter: false
  winfsp: true
  windivert: false

summary:
  available: ["landlock", "capabilities_drop", "cgroups_v2"]
  unavailable: ["seccomp", "ebpf", "fuse"]

tips:
  - feature: fuse
    status: unavailable
    impact: "Fine-grained filesystem control disabled"
    action: "Install FUSE3: apt install fuse3 (Debian/Ubuntu), dnf install fuse3 (Fedora), or pacman -S fuse3 (Arch)"
```

---

## Actionable Tips

Tips provide guidance on how to enable unavailable capabilities.

### Linux Tips

| Feature | Impact | Action |
|---------|--------|--------|
| `fuse` | Fine-grained filesystem control disabled | `apt install fuse3` (Debian/Ubuntu), `dnf install fuse3` (Fedora), `pacman -S fuse3` (Arch) |
| `landlock_network` | Kernel-level network restrictions disabled | Requires kernel 6.7+. Upgrade kernel or use proxy-based network control. |
| `seccomp` | Syscall filtering disabled | Run in privileged container or on host. Nested containers don't support seccomp user-notify. |
| `ebpf` | Network monitoring disabled | Requires CAP_BPF and cgroups v2. Run as root or with elevated privileges. |
| `cgroups_v2` | Resource limits unavailable | Mount cgroups v2: `mount -t cgroup2 none /sys/fs/cgroup` or enable in kernel config. |

### macOS Tips

| Feature | Impact | Action |
|---------|--------|--------|
| `fuse_t` | File policy enforcement limited to observation-only | `brew install fuse-t` |
| `esf` | Using sandbox-exec instead of Endpoint Security | ESF requires Apple developer approval. Submit business justification to Apple. |
| `network_extension` | No kernel-level network filtering | Enable Network Extension capability in Xcode. |
| `lima_available` | No Linux VM isolation available | `brew install lima && limactl start default` |

### Windows Tips

| Feature | Impact | Action |
|---------|--------|--------|
| `winfsp` | FUSE-style filesystem mounting disabled | `winget install WinFsp.WinFsp` |
| `minifilter` | No kernel-level file interception | Install agentsh minifilter driver (requires Administrator). |
| `windivert` | Transparent network interception disabled | Install WinDivert. Falls back to WFP block-only mode. |
| `app_container` | Process isolation limited | Requires Windows 8+. Using Job Objects as fallback. |

---

## Generated Config Format

### Linux (Landlock ABI v4, no seccomp/eBPF/FUSE)

```yaml
# Generated by: agentsh detect config
# Platform: linux
# Security mode: landlock-only
# Protection score: ~80%

security:
  mode: landlock-only
  strict: true
  warn_degraded: true

landlock:
  enabled: true
  allow_execute:
    - /usr/bin
    - /bin
    - /usr/local/bin
  allow_read:
    - /etc
    - /lib
    - /lib64
    - /usr/lib
  deny_paths:
    - /var/run/docker.sock
    - /run/containerd/containerd.sock
  network:
    allow_connect_tcp: true
    allow_bind_tcp: false

capabilities:
  allow: []
```

### Linux (Landlock ABI v3, no network support)

```yaml
# Generated by: agentsh detect config
# Platform: linux
# Security mode: landlock-only
# Protection score: ~75%
# Note: Network restrictions unavailable (requires kernel 6.7+)

security:
  mode: landlock-only
  strict: true
  warn_degraded: true

landlock:
  enabled: true
  allow_execute:
    - /usr/bin
    - /bin
    - /usr/local/bin
  allow_read:
    - /etc
    - /lib
    - /lib64
    - /usr/lib
  deny_paths:
    - /var/run/docker.sock
    - /run/containerd/containerd.sock
  # network section omitted - requires kernel 6.7+ (Landlock ABI v4)

capabilities:
  allow: []
```

### Linux (Full mode)

```yaml
# Generated by: agentsh detect config
# Platform: linux
# Security mode: full
# Protection score: 100%

security:
  mode: full
  strict: true

# Full mode uses seccomp + eBPF + FUSE - no landlock section needed
# Configure sandbox settings in sandbox: section of main config

capabilities:
  allow: []
```

### macOS (FUSE-T available)

```yaml
# Generated by: agentsh detect config
# Platform: darwin
# Security mode: fuse-t
# Protection score: ~70%

security:
  mode: auto
  strict: false
  warn_degraded: true

sandbox:
  capabilities: []
  # network capability can be added if outbound access needed
  # capabilities:
  #   - network
```

### Windows (AppContainer + WinFsp)

```yaml
# Generated by: agentsh detect config
# Platform: windows
# Security mode: appcontainer
# Protection score: ~75%

security:
  mode: auto
  strict: false

sandbox:
  windows:
    use_app_container: true
    use_minifilter: false
    network_access: none
```

---

## Implementation Architecture

### File Structure

```
internal/cli/
  detect.go                    # CLI command (all platforms)

internal/capabilities/
  detect_result.go             # DetectResult struct + formatters
  detect_result_test.go

  security_caps.go             # Linux detection (existing, extend)
  security_caps_darwin.go      # macOS detection (new)
  security_caps_windows.go     # Windows detection (new)
  security_caps_other.go       # Stub for unsupported platforms

  config_generator.go          # Config generation logic
  config_generator_test.go

  tips.go                      # Actionable tips per platform
  tips_test.go
```

### Key Types

```go
// DetectResult is the unified cross-platform detection result.
type DetectResult struct {
    Platform        string         `json:"platform" yaml:"platform"`
    SecurityMode    string         `json:"security_mode" yaml:"security_mode"`
    ProtectionScore int            `json:"protection_score" yaml:"protection_score"`
    Capabilities    map[string]any `json:"capabilities" yaml:"capabilities"`
    Summary         DetectSummary  `json:"summary" yaml:"summary"`
    Tips            []Tip          `json:"tips" yaml:"tips"`
}

type DetectSummary struct {
    Available   []string `json:"available" yaml:"available"`
    Unavailable []string `json:"unavailable" yaml:"unavailable"`
}

type Tip struct {
    Feature string `json:"feature" yaml:"feature"`
    Status  string `json:"status" yaml:"status"`
    Impact  string `json:"impact" yaml:"impact"`
    Action  string `json:"action" yaml:"action"`
}

// Detect runs platform-specific detection and returns unified result.
func Detect() (*DetectResult, error)

// GenerateConfig creates a config snippet from detection results.
func GenerateConfig(result *DetectResult) ([]byte, error)
```

---

## Table Output Format

```
$ agentsh detect

Platform: linux
Security Mode: landlock-only
Protection Score: 80%

CAPABILITIES
+-----------------------+-----------+
| Feature               | Status    |
+-----------------------+-----------+
| seccomp               | -         |
| seccomp_user_notify   | -         |
| landlock              | ✓ (ABI 4) |
| landlock_network      | ✓         |
| ebpf                  | -         |
| fuse                  | -         |
| cgroups_v2            | ✓         |
| capabilities_drop     | ✓         |
+-----------------------+-----------+

TIPS
• fuse: Install FUSE3 for fine-grained filesystem control
  → apt install fuse3 (Debian/Ubuntu), dnf install fuse3 (Fedora), pacman -S fuse3 (Arch)

• seccomp: Syscall filtering unavailable (nested container detected)
  → Run in privileged container or on host for full seccomp support

Run 'agentsh detect config' to generate an optimized configuration.
```

---

## Testing Strategy

1. **Unit tests** for each platform's detection logic (mock syscalls)
2. **Unit tests** for config generation with various capability combinations
3. **Unit tests** for tip generation
4. **Integration test** that runs `agentsh detect` and verifies output format
5. **Golden file tests** for config generation output

---

## Related Documentation

- [Security Modes](../security-modes.md)
- [Cross-Platform Notes](../cross-platform.md)
