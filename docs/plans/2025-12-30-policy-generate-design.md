# Policy Generate Command Design

**Date:** 2025-12-30
**Status:** Implemented

## Overview

Add a CLI command to generate restrictive policies from session activity. This enables a "profile-then-lock" workflow: run a workload in a permissive session with audit logging, then generate a policy that only allows what was observed.

**Use cases:**
- CI/CD lockdown - Profile a build/test run, lock future runs to that behavior
- Agent sandboxing - Let AI agent run a task, generate policy for future runs
- Container profiling - Profile a workload, generate minimal policy for production

## CLI Interface

```
agentsh policy generate <session-id|latest> [flags]
```

**Flags:**
- `--output=<path>` - Write to file (default: stdout)
- `--name=<string>` - Policy name (default: `generated-<session-id>`)
- `--threshold=<N>` - Files in same dir before collapsing to glob (default: 5)
- `--include-blocked` - Include blocked ops as comments (default: true)
- `--arg-patterns` - Generate arg patterns for risky commands (default: true)

**Examples:**
```bash
# Generate policy from latest session
agentsh policy generate latest --output=ci-policy.yaml

# Generate with custom name and threshold
agentsh policy generate abc123 --name=production-build --threshold=10

# Quick stdout preview
agentsh policy generate latest
```

**Errors:**
- Session not found → clear error with suggestion to run `agentsh session list`
- Session has no events → "Session abc123 has no event data. Run with audit logging enabled."
- Session has <10 events → Warning about minimal activity

## Data Flow

```
Session ID → Load events from SQLite → Group by category (file/net/cmd/ipc)
           → Apply grouping heuristics → Generate rules with provenance
           → Add blocked ops as comments → Validate → Output YAML
```

## Grouping Heuristics

### File Path Grouping

**Threshold-based collapse:**
```
/workspace/src/a.ts, /workspace/src/b.ts, /workspace/src/c.ts (threshold=3)
  → /workspace/src/**
```

**Extension-aware narrowing:**
```
/workspace/src/*.ts (12 files), /workspace/src/*.js (2 files)
  → /workspace/src/**/*.ts  (if ts is >80% of directory)
  → /workspace/src/**       (otherwise)
```

**Common prefix detection:**
```
/workspace/node_modules/lodash/**, /workspace/node_modules/express/**
  → /workspace/node_modules/** (if >threshold subdirs)
```

### Network Domain Grouping

**Subdomain collapse (preferred):**
```
api.github.com, raw.github.com, gist.github.com
  → *.github.com
```

**Port handling:**
```
*.github.com:443, *.github.com:22
  → separate rules (different ports = different intent)
```

**CIDR detection (for raw IPs):**
```
10.0.1.5, 10.0.1.6, 10.0.1.12
  → 10.0.1.0/24 (if IPs cluster in same /24)
```

### Command Grouping

**Safe commands - command only:**
```
npm install, npm test, npm run build
  → commands: [npm]  # no arg patterns
```

**Risky commands - with arg patterns:**
```
curl https://api.github.com/..., curl https://registry.npmjs.org/...
  → commands: [curl]
    args_patterns: ["^https://(api\\.github\\.com|registry\\.npmjs\\.org)/"]
```

## Risky Command Detection

### Built-in List

| Category | Commands |
|----------|----------|
| Network-capable | curl, wget, ssh, scp, rsync, nc, netcat, telnet, ftp |
| Destructive | rm, chmod, chown |
| Privileged | sudo, su, doas |
| Container | docker, podman |
| Orchestration | kubectl, helm |
| Package managers | pip, gem, cargo |

### Dynamic Detection

Commands are also marked risky if they:
1. **Made network connections** - Associated with `net_connect` events
2. **Deleted files** - Associated with `file_delete` events
3. **Changed privileges** - Ran with different UID than parent

### Arg Pattern Extraction

For risky commands:
- Extract URLs from args → group by domain
- Extract file paths from args → apply path grouping heuristics
- Generate regex matching observed patterns

## Output Format

```yaml
# Generated by: agentsh policy generate abc123-def4-5678
# Source session: abc123-def4-5678
# Generated at: 2025-12-30T14:32:00Z
# Session duration: 12m 34s
# Total events analyzed: 1,847

version: 1
name: generated-abc123
description: Auto-generated from session abc123-def4-5678

file_rules:
  # --- Allowed file operations (47 unique paths → 3 rules) ---

  - name: workspace-src-writes
    description: "Source file access"
    # Provenance: 89 events (first: 14:20:01, last: 14:31:45)
    # Sample paths: /workspace/src/index.ts, /workspace/src/utils.ts
    paths: ["/workspace/src/**"]
    operations: [read, write, create]
    decision: allow

  - name: node-modules-read
    # Provenance: 342 events across 156 packages
    paths: ["/workspace/node_modules/**"]
    operations: [read, stat]
    decision: allow

  # --- Blocked operations (commented for review) ---
  # - name: etc-hosts-write
  #   # BLOCKED during session at 14:21:03
  #   # Original path: /etc/hosts
  #   # Reason: Write to system file denied
  #   paths: ["/etc/hosts"]
  #   operations: [write]
  #   decision: allow  # Uncomment to permit

network_rules:
  - name: github-api
    # Provenance: 5 connections (14:20:15 - 14:28:33)
    domains: ["*.github.com"]
    ports: [443]
    decision: allow

  - name: npm-registry
    # Provenance: 3 connections
    domains: ["registry.npmjs.org"]
    ports: [443]
    decision: allow

command_rules:
  - name: build-tools
    # Provenance: npm (12x), node (18x), git (9x)
    commands: [npm, node, git]
    decision: allow

  - name: curl-restricted
    # Provenance: 2 invocations (risky: network-capable)
    # curl https://api.github.com/repos/...
    # curl https://registry.npmjs.org/...
    commands: [curl]
    args_patterns: ["^https://(api\\.github\\.com|registry\\.npmjs\\.org)/"]
    decision: allow

  # --- Blocked commands ---
  # - name: curl-external
  #   # BLOCKED at 14:25:00 (operator denied)
  #   # Original: curl https://external.io/upload
  #   commands: [curl]
  #   args_patterns: ["^https://external\\.io/"]
  #   decision: allow  # Uncomment to permit

unix_socket_rules:
  - name: docker-socket
    # Provenance: 3 connect operations
    # WARNING: Docker socket access grants significant privileges
    paths: ["/var/run/docker.sock"]
    operations: [connect]
    decision: allow
```

## Edge Cases

| Scenario | Handling |
|----------|----------|
| Empty session (<10 events) | Warning about minimal activity |
| No audit logging | Error with suggestion to enable |
| Conflicting ops (read + write same path) | Combine operations |
| Same command allowed + blocked | Allowed in rules, blocked in comments |
| Very large sessions (>100k events) | Stream processing with progress indicator |
| Relative/symlink paths | Resolve to absolute canonical |
| Deleted files (can't resolve) | Use as-is with uncertainty comment |
| Docker socket access | Generate rule + warning about risk |

## Implementation

### New Files
- `internal/cli/policy_generate.go` - CLI command definition
- `internal/policygen/generator.go` - Core generation logic
- `internal/policygen/grouping.go` - Path/domain/command grouping heuristics
- `internal/policygen/risky.go` - Risky command detection
- `internal/policygen/generator_test.go` - Unit tests

### Integration Points
- Query events from SQLite via existing `internal/events/store.go`
- Resolve "latest" session via `internal/session/manager.go`
- Output uses existing `internal/policy/model.go` structures
- Validate output with `Policy.Validate()`

### Performance Considerations
- Stream events for large sessions (don't load all in memory)
- Use efficient grouping data structures (tries for path prefixes)
- Progress indicator for >10k events

## Out of Scope (for now)

- Interactive mode (prompting for each blocked op)
- Policy diff (compare generated vs existing policy)
- Policy merge (combine multiple session profiles)
- Automatic policy testing against session replay
