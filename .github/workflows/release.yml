name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: release-${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            release-${{ runner.os }}-go-

      - name: Install build deps (envshim, fuse, seccomp)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libseccomp-dev \
            libfuse-dev \
            pkg-config \
            gcc-aarch64-linux-gnu \
            make

      - name: Test
        run: go test -p=1 ./...

      - name: Smoke
        run: make smoke

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: v2.13.1
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Build Alpine/musl binaries separately (requires different libc)
  alpine-build:
    runs-on: ubuntu-latest
    needs: goreleaser  # Wait for release to be created
    timeout-minutes: 20
    container:
      image: golang:1.25-alpine
    steps:
      - uses: actions/checkout@v4

      - name: Install Alpine build dependencies
        run: |
          apk add --no-cache \
            gcc \
            musl-dev \
            libseccomp-dev \
            libseccomp-static \
            make \
            git \
            file

      - name: Build agentsh (Alpine/musl static)
        run: |
          CGO_ENABLED=1 \
          CGO_LDFLAGS="-static -lseccomp" \
          go build -ldflags='-s -w -extldflags "-static"' \
            -o agentsh ./cmd/agentsh

          # Verify it's statically linked
          file agentsh

      - name: Build agentsh-unixwrap (Alpine/musl static)
        run: |
          CGO_ENABLED=1 \
          CGO_LDFLAGS="-static -lseccomp" \
          go build -ldflags='-s -w -extldflags "-static"' \
            -o agentsh-unixwrap ./cmd/agentsh-unixwrap

          # Verify it's statically linked
          file agentsh-unixwrap

      - name: Build agentsh-shell-shim (Alpine/musl)
        run: |
          CGO_ENABLED=0 \
          go build -ldflags='-s -w' \
            -o agentsh-shell-shim ./cmd/agentsh-shell-shim

      - name: Create Alpine tarball
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          mkdir -p dist
          tar -czvf "dist/agentsh_${VERSION}_linux_amd64_musl.tar.gz" \
            agentsh \
            agentsh-unixwrap \
            agentsh-shell-shim \
            packaging/bash_startup.sh \
            README.md \
            LICENSE \
            config.yml \
            default-policy.yml

      - name: Upload Alpine binaries to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.ref_name }}
        run: |
          # Install gh CLI in Alpine
          apk add --no-cache github-cli

          gh release upload "$VERSION" \
            "dist/agentsh_${VERSION}_linux_amd64_musl.tar.gz" \
            --repo "${{ github.repository }}" \
            --clobber

  # Run integration tests across all supported Linux distros.
  docker-test:
    runs-on: ubuntu-latest
    needs: [goreleaser, alpine-build]
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: debian
            dockerfile: Dockerfile.test
            docker_run_flags: ""
          - name: fedora
            dockerfile: Dockerfile.test.rpm
            docker_run_flags: ""
          - name: archlinux
            dockerfile: Dockerfile.test.arch
            docker_run_flags: ""
          - name: alpine
            dockerfile: Dockerfile.test.alpine
            docker_run_flags: ""
          - name: ubuntu
            dockerfile: Dockerfile.test.ubuntu
            docker_run_flags: "--device /dev/fuse --cap-add SYS_ADMIN"
    steps:
      - uses: actions/checkout@v4

      - name: Build and run ${{ matrix.name }} integration test
        env:
          DOCKER_BUILDKIT: "1"
        run: |
          docker build -f ${{ matrix.dockerfile }} \
            --build-arg AGENTSH_TAG=${{ github.ref_name }} \
            -t agentsh-test-${{ matrix.name }}:latest .
          RUN_FLAGS="${{ matrix.docker_run_flags }}"
          # Only pass FUSE flags if /dev/fuse exists on the runner
          if echo "$RUN_FLAGS" | grep -q '/dev/fuse' && [ ! -e /dev/fuse ]; then
            echo "::warning::Skipping FUSE flags: /dev/fuse not available on this runner"
            RUN_FLAGS=""
          fi
          docker run --rm $RUN_FLAGS agentsh-test-${{ matrix.name }}:latest
